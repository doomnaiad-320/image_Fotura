# 二次编辑功能测试指南

本文档提供了二次编辑功能的详细测试步骤,包括 Web 端和移动端测试场景。

## 前置准备

### 1. 启动开发环境

```bash
# 安装依赖
npm install

# 初始化数据库(如果是首次运行)
npx prisma migrate deploy
npm run prisma:generate
npm run seed

# 启动开发服务器
npm run dev
```

### 2. 登录测试账号

访问 http://localhost:3000 并登录:
- **普通用户**: `user@aigc.studio` / `User123!@#`
- **管理员**: `admin@aigc.studio` / `Admin123!@#` (可调整Credits)

---

## Web 端测试

### 测试场景 1: 基础二次编辑流程

**目标**: 验证"作为输入"功能和 Prompt 继承机制

**步骤**:
1. ✅ 进入 AI 工作台 (`/ai/playground`)
2. ✅ 选择一个图像生成模型
3. ✅ 选择文生图模式
4. ✅ 输入测试 Prompt: `一只可爱的橙色小猫,坐在花园里,阳光明媚`
5. ✅ 选择尺寸 `1024x1024`
6. ✅ 点击"生成图像"并等待结果
7. ✅ 检查结果是否正确显示
8. ✅ 点击结果下方的"作为输入"按钮

**预期结果**:
- ✅ 页面自动切换到图生图模式
- ✅ 原图被加载到编辑器画布
- ✅ Prompt 输入框自动填充原始提示词
- ✅ Prompt 输入框上方显示橙色"已继承"徽章
- ✅ Toast 提示: "已加载为输入图,提示词已继承"

---

### 测试场景 2: Prompt 修改与徽章状态

**目标**: 验证 Prompt 修改后徽章消失

**步骤**:
1. ✅ 在测试场景 1 的基础上
2. ✅ 修改 Prompt 为: `一只可爱的橙色小猫,坐在花园里,阳光明媚,**增加蝴蝶和花朵**`
3. ✅ 观察徽章状态

**预期结果**:
- ✅ "已继承"徽章立即消失
- ✅ Prompt 输入框状态变为手动输入

---

### 测试场景 3: 局部涂选功能

**目标**: 验证 Mask 工具的绘制、撤销和清除

**步骤**:
1. ✅ 在图生图模式下,图片已加载
2. ✅ 点击"局部涂选"按钮
3. ✅ 画笔工具面板出现,显示笔刷大小滑块
4. ✅ 在图片上绘制几条线(标记要修改的区域)
5. ✅ 点击"撤销"按钮
6. ✅ 再次绘制,然后点击"清除涂选"

**预期结果**:
- ✅ 涂选按钮激活时变为橙色渐变
- ✅ 画笔绘制出半透明橙色线条(70% 不透明度)
- ✅ 撤销按钮回退最后一步操作
- ✅ 清除按钮移除所有涂选
- ✅ 撤销和清除按钮在无历史时禁用

---

### 测试场景 4: 对比视图切换

**目标**: 验证三种视图模式(结果/对比/滑块)

**步骤**:
1. ✅ 完成一次二次编辑生成(场景 1 + 修改 Prompt + 生成)
2. ✅ 结果显示后,点击"对比"按钮
3. ✅ 点击"滑块"按钮
4. ✅ 拖动滑块左右移动
5. ✅ 点击"结果"按钮

**预期结果**:
- ✅ 对比模式:左侧显示原图,右侧显示新图,各带标签
- ✅ 滑块模式:两张图重叠,拖动滑块可对比
- ✅ 滑块有橙色拖动手柄,响应鼠标拖动
- ✅ 结果模式:只显示生成结果

---

### 测试场景 5: 链式编辑

**目标**: 验证多次迭代编辑

**步骤**:
1. ✅ 完成测试场景 4
2. ✅ 再次点击生成结果下的"作为输入"
3. ✅ 修改 Prompt: `改变背景为夜晚星空`
4. ✅ 点击"重绘图像"
5. ✅ 检查历史记录是否保存所有版本

**预期结果**:
- ✅ 第二次编辑时,上一次的生成结果成为新的原图
- ✅ 历史面板显示完整编辑链 (A → B → C)
- ✅ 每个历史项显示对应的 Prompt 和模式标记
- ✅ Credits 正确扣费

---

### 测试场景 6: Prompt 清空功能

**目标**: 验证清空按钮

**步骤**:
1. ✅ 在图生图模式,Prompt 输入框有内容
2. ✅ 点击 Prompt 输入框右侧的"清空"按钮(带 ✕ 图标)

**预期结果**:
- ✅ Prompt 输入框内容被清空
- ✅ promptOrigin 变为 'manual'
- ✅ 如果之前有徽章,徽章消失

---

## 移动端测试 (Safari iOS / Chrome Android)

### 测试场景 7: 响应式布局

**目标**: 验证移动端布局自适应

**步骤**:
1. ✅ 使用手机浏览器访问 http://localhost:3000
2. ✅ 登录并进入 AI 工作台
3. ✅ 检查界面布局

**预期结果**:
- ✅ 控制面板和结果区域垂直排列(grid-cols-1)
- ✅ 按钮文字大小适配小屏幕
- ✅ 图片编辑器保持正方形(aspect-square)
- ✅ 没有横向滚动

---

### 测试场景 8: 触摸涂选

**目标**: 验证移动端 Mask 绘制

**步骤**:
1. ✅ 加载图片到编辑器
2. ✅ 点击"局部涂选"按钮
3. ✅ 用手指在图片上绘制
4. ✅ 调整笔刷大小滑块
5. ✅ 点击撤销和清除

**预期结果**:
- ✅ 手指触摸绘制流畅,无页面滚动干扰(touchAction: 'none')
- ✅ 笔刷大小滑块可拖动调整
- ✅ 撤销/清除按钮响应触摸

---

### 测试场景 9: 触摸滑块对比

**目标**: 验证移动端滑块交互

**步骤**:
1. ✅ 完成一次二次编辑
2. ✅ 切换到滑块视图模式
3. ✅ 用手指左右滑动滑块

**预期结果**:
- ✅ 滑块响应触摸拖动
- ✅ 图片实时切换显示
- ✅ 拖动流畅,无卡顿

---

## 边缘场景测试

### 测试场景 10: 无历史记录时使用"作为输入"

**目标**: 验证历史记录未找到时的降级处理

**步骤**:
1. ✅ 清空浏览器 IndexedDB 或使用隐身模式
2. ✅ 通过外部 URL 直接加载图片到编辑器
3. ✅ 使用"作为输入"功能

**预期结果**:
- ✅ 图片正常加载
- ✅ Toast 提示: "图片已设为输入,可以开始二次编辑"
- ✅ 无"已继承"徽章
- ✅ Prompt 为空或保持原值

---

### 测试场景 11: Credits 不足

**目标**: 验证余额不足时的处理

**步骤**:
1. ✅ 使用管理员账号将测试用户 Credits 调整为 5
2. ✅ 选择一个高价格模型
3. ✅ 尝试二次编辑生成

**预期结果**:
- ✅ 显示错误提示: "余额不足"
- ✅ 不扣除 Credits
- ✅ 生成按钮可再次点击

---

### 测试场景 12: 网络错误处理

**目标**: 验证 API 失败时的处理

**步骤**:
1. ✅ 打开浏览器开发者工具 Network 面板
2. ✅ 设置网络节流为"Offline"
3. ✅ 尝试二次编辑生成

**预期结果**:
- ✅ 显示错误提示: "编辑失败"或具体错误信息
- ✅ Credits 不扣费(通过 refund)
- ✅ loading 状态正确恢复

---

## 性能测试

### 测试场景 13: 大尺寸图片处理

**目标**: 验证 1024x1024 及以上尺寸的性能

**步骤**:
1. ✅ 生成 1024x1024 图片
2. ✅ 使用"作为输入"
3. ✅ 绘制复杂 Mask
4. ✅ 重新生成

**预期结果**:
- ✅ 图片加载无明显延迟(<2s)
- ✅ Mask 绘制流畅(60fps)
- ✅ 生成请求正常完成

---

## 兼容性矩阵

| 浏览器 | 桌面端 | 移动端 | 状态 |
|--------|--------|--------|------|
| Chrome 120+ | ✅ | ✅ | 完全支持 |
| Safari 17+ | ✅ | ✅ | 完全支持 |
| Firefox 120+ | ✅ | ⚠️ | 需验证滑块 |
| Edge 120+ | ✅ | N/A | 完全支持 |

---

## 回归测试清单

每次代码变更后,运行以下快速检查:

- [ ] 文生图基础功能正常
- [ ] "作为输入"按钮可点击
- [ ] Prompt 继承正确显示徽章
- [ ] 局部涂选工具可用
- [ ] 对比视图三模式切换正常
- [ ] 历史记录保存完整
- [ ] Credits 扣费正确
- [ ] 移动端布局无错位

---

## 已知问题

目前无已知问题。如发现 Bug,请按以下格式记录:

**问题**: [简短描述]  
**复现步骤**: [步骤列表]  
**预期行为**: [应该怎样]  
**实际行为**: [实际怎样]  
**环境**: [浏览器/设备/版本]  
**截图**: [如有必要]

---

## 自动化测试运行

```bash
# 运行所有测试
npm run test

# 只运行单元测试
npm run test:unit

# E2E 测试(需要启动 dev 服务器)
npm run test:e2e
```

### 待实现的自动化测试

- [ ] `tests/unit/playground-advanced.test.ts` - handleUseImageAsInput 逻辑测试
- [ ] `tests/unit/result-display.test.ts` - 视图模式切换测试
- [ ] `tests/e2e/secondary-edit.spec.ts` - 完整二次编辑流程 E2E

---

**最后更新**: 2025-01-14  
**测试负责人**: AIGC Studio 开发团队
