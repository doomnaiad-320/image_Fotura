# 积分日志功能说明

## 功能概述

在管理后台新增了**积分日志**页面，用于查看所有用户的积分交易记录，包括：
- ✅ 充值记录
- ✅ 消费记录（AI 调用）
- ✅ 复用奖励
- ✅ 退款记录
- ✅ 管理员调整

## 访问方式

1. 登录管理后台：`http://localhost:3000/admin`
2. 点击左侧导航的 "积分日志" 菜单
3. 或直接访问：`http://localhost:3000/admin/logs`

## 页面功能

### 1. 交易记录表格

显示所有积分交易记录，包含以下字段：

| 字段 | 说明 |
|------|------|
| 时间 | 交易发生时间（精确到秒） |
| 用户 | 用户头像、名称、邮箱 |
| 积分变动 | 增加（绿色↑）或减少（红色↓） |
| 原因 | 交易原因，带图标分类 |
| 状态 | 成功/处理中/失败/已退款 |
| 关联信息 | 提供商、模型、请求ID、关联作品等 |

### 2. 状态筛选

支持按交易状态筛选：
- **全部**: 显示所有记录
- **成功**: 只显示成功的交易
- **处理中**: 只显示待处理的交易
- **失败**: 只显示失败的交易
- **已退款**: 只显示已退款的交易

### 3. 分页功能

- 每页显示 50 条记录
- 支持上一页/下一页翻页
- 显示当前页码和总页数
- 显示总记录数

### 4. 统计卡片

页面底部显示当前页的统计信息：
- **总交易数**: 总记录数
- **充值/奖励**: 所有正数变动的总和（绿色）
- **消费**: 所有负数变动的总和（红色）
- **成功交易**: 成功状态的交易数量

## 交易类型识别

系统会根据交易原因自动标识交易类型：

| 图标 | 类型 | 关键词 | 颜色 |
|------|------|--------|------|
| 💰 | 充值/赠送 | 充值、赠送、注册 | 绿色 |
| 🎁 | 复用/奖励 | 复用、奖励 | 蓝色 |
| ↩️ | 退款 | 退款 | 黄色 |
| 📝 | 其他 | 其他情况 | 灰色 |

## 交易状态说明

| 状态 | 图标 | 说明 | 颜色 |
|------|------|------|------|
| success | ✓ | 交易成功完成 | 绿色 |
| pending | ⏱ | 正在处理中（预扣款） | 黄色 |
| failed | ⚠ | 交易失败 | 红色 |
| refunded | ↻ | 已退款 | 蓝色 |

## 典型交易场景

### 1. 新用户注册
```
用户: user@aigc.studio
积分变动: +5000
原因: 💰 注册赠送
状态: ✓ 成功
```

### 2. AI 对话消费
```
用户: user@aigc.studio
积分变动: -120
原因: 📝 AI 对话消费
状态: ✓ 成功
关联信息: 
  提供商: OpenAI
  模型: GPT-4
  请求ID: abc123...
```

### 3. 复用奖励
```
用户: creator@aigc.studio
积分变动: +50
原因: 🎁 作品被复用奖励
状态: ✓ 成功
关联信息: 🔗 关联作品
```

### 4. 管理员调整
```
用户: user@aigc.studio
积分变动: +10000
原因: 💰 管理员充值
状态: ✓ 成功
```

### 5. AI 调用失败退款
```
用户: user@aigc.studio
积分变动: +120
原因: ↩️ AI 调用失败，自动退款
状态: ↻ 已退款
```

## API 接口

### GET /api/admin/credit-logs

获取积分交易记录列表

**权限要求**: 管理员

**查询参数**:
- `page` (可选): 页码，默认 1
- `pageSize` (可选): 每页记录数，默认 50，最大 100
- `status` (可选): 状态筛选（success/pending/failed/refunded）
- `userId` (可选): 按用户ID筛选

**响应示例**:
```json
{
  "transactions": [
    {
      "id": "tx_abc123",
      "userId": "user_xyz",
      "user": {
        "id": "user_xyz",
        "email": "user@aigc.studio",
        "name": "测试用户",
        "role": "user"
      },
      "delta": -120,
      "reason": "AI 对话消费",
      "status": "success",
      "provider": {
        "name": "OpenAI",
        "slug": "openai"
      },
      "model": {
        "displayName": "GPT-4",
        "slug": "gpt-4"
      },
      "requestId": "req_abc123",
      "createdAt": "2025-10-22T02:00:00.000Z",
      "updatedAt": "2025-10-22T02:00:01.000Z"
    }
  ],
  "pagination": {
    "page": 1,
    "pageSize": 50,
    "total": 150,
    "totalPages": 3
  }
}
```

## 数据来源

积分日志数据来源于 `CreditTransaction` 表，该表记录所有积分变动：

### 字段说明

| 字段 | 类型 | 说明 |
|------|------|------|
| id | String | 交易唯一ID |
| userId | String | 用户ID |
| delta | Int | 积分变动（正数=增加，负数=减少） |
| reason | String | 交易原因 |
| status | String | 交易状态 |
| providerId | String? | 关联的AI提供商ID |
| modelId | String? | 关联的AI模型ID |
| requestId | String? | 关联的请求ID |
| refWorkId | String? | 关联的作品ID（复用场景） |
| refUserId | String? | 关联的用户ID（复用场景） |
| metadata | String | 额外信息（JSON格式） |
| createdAt | DateTime | 创建时间 |

### 触发场景

1. **用户注册**: `lib/auth.ts` - `registerUser()`
2. **AI 调用预扣**: `lib/credits.ts` - `prechargeCredits()`
3. **AI 调用结算**: `lib/credits.ts` - `finalizeCredits()`
4. **退款**: `lib/credits.ts` - `refundCredits()`
5. **管理员调整**: `lib/credits.ts` - `adjustCreditsByAdmin()`
6. **复用奖励**: 复用相关业务逻辑

## 使用建议

### 查看用户积分流水
1. 在用户管理页面找到目标用户
2. 记下用户邮箱或ID
3. 进入积分日志页面
4. 未来可添加：点击用户名直接筛选该用户的所有交易

### 排查积分异常
1. 访问积分日志页面
2. 使用状态筛选查看 "失败" 或 "已退款" 的记录
3. 查看关联信息和请求ID
4. 根据需要联系用户或检查系统日志

### 统计积分消耗
1. 查看统计卡片的"消费"总额
2. 可按状态筛选"成功"记录以排除失败交易
3. 按时间段查看（未来功能）

### 验证充值/奖励
1. 使用状态筛选查看"成功"记录
2. 查看"充值/奖励"统计卡片
3. 确认积分变动为正数的记录

## 导航菜单更新

原管理后台导航菜单：
- 概览
- AI 管理
- 用户管理
- ~~资产管理~~ (已移除)
- ~~操作日志~~ (已重命名)
- 系统设置

新管理后台导航菜单：
- 概览
- AI 管理
- 用户管理
- **积分日志** ← 新增/重命名
- 系统设置

## 相关文件

### 新增文件
- `app/api/admin/credit-logs/route.ts` - API 端点
- `app/(web)/admin/logs/page.tsx` - 前端页面

### 修改文件
- `app/(web)/admin/layout.tsx` - 更新导航菜单

## 未来增强

可以考虑添加：
1. **按用户筛选**: 点击用户名快速筛选该用户的所有交易
2. **时间范围筛选**: 选择开始和结束日期
3. **导出功能**: 导出为 CSV 或 Excel
4. **交易详情弹窗**: 显示完整的 metadata 和更多信息
5. **图表统计**: 积分消耗趋势图、用户消费排行等
6. **搜索功能**: 按请求ID、交易ID等搜索

## 注意事项

1. **性能考虑**: 大量数据时分页加载，避免一次加载所有记录
2. **权限控制**: 只有管理员可以查看所有用户的交易记录
3. **数据完整性**: 所有积分变动都通过 `lib/credits.ts` 中的函数处理，确保有记录
4. **状态理解**: `pending` 状态表示预扣款，实际消费可能与预扣款不同
