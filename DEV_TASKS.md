# 开发任务文档（可执行清单）

说明：本清单聚焦“SQLite 开发、MySQL 上线”的落地与全链路优化。默认优先级 P0>P1>P2；状态：TODO/DOING/DONE。Owner 请在接手时补充。

---

## P0（上线前必须完成）

- [ ] 数据库（Schema/迁移）
  - [ ] 在 `schema.prisma` 明确所有外键/唯一/索引，限制唯一列到 `@db.VarChar(191)`（utf8mb4）。
  - [ ] 生成 MySQL 迁移 SQL 并代码审阅：
        `npx prisma migrate diff --from-url file:./prisma/dev.db --to-url mysql://... --script > prisma/migrations/20xx_mysql.sql`
  - [ ] 预生产 MySQL 执行迁移，验证外键/约束/索引、数据兼容性。
  - [ ] 为 destructive 变更准备回滚脚本或影子表策略。
- [ ] 应用配置与连接
  - [ ] 统一 Prisma Client 单例复用；设置 `PRISMA_CLIENT_ENGINE_TYPE=library`。
  - [ ] `DATABASE_URL` 含 `connection_limit` 与 `socket_timeout`，生产启用 SSL。
  - [ ] 限流/重试：关键 API 增加超时与重试策略，防止连接挤占。
- [ ] 性能与缓存
  - [ ] 为关键查询补充/调整索引；用 `EXPLAIN` 验证命中与扫描行数。
  - [ ] 接入 Redis 缓存热点查询（设置 TTL、失效策略）。
  - [ ] Next.js 路由启用 `revalidate` 或缓存策略，静态资源接入 CDN。
- [ ] 观测与告警
  - [ ] 开启 MySQL 慢查询日志并采集；建立 p95/p99、错误率仪表盘与阈值告警。
  - [ ] 接入 Sentry/APM（后端与前端），记录关键业务事件与异常。
- [ ] 安全与合规
  - [ ] 数据库仅内网访问，最小权限账户，强制 TLS。
  - [ ] Secret 管理（KMS/Secret Manager），禁用明文与硬编码。
- [ ] 备份与演练
  - [ ] 开启 binlog（ROW）与定期逻辑备份；设置 7 天保留策略。
  - [ ] 进行一次预生产恢复演练，记录 RTO/RPO。
- [ ] 上线灰度
  - [ ] 小流量（5%）灰度 + 慢查阈值与错误率阈值观测，逐步扩大流量。

---

## P1（尽快完成）

- [ ] 查询与事务
  - [ ] 消除主要 N+1；将循环内单条查询改为批量/JOIN。
  - [ ] 大事务改分批；对热点更新增加幂等键与重试。
- [ ] 架构与构建
  - [ ] Docker 化本地 MySQL（保持开发/预生产一致）。
  - [ ] 分离只读/只写路径（可选），读多场景走只读副本或缓存。
- [ ] CI/CD
  - [ ] Pipeline 增加：迁移 SQL 生成与语法检查、预生产自动执行与回归用例。
  - [ ] 部署前自动备份快照；部署后自动回滚脚本可调用。
- [ ] 测试
  - [ ] 在 CI 中引入 MySQL 容器，跑集成/E2E 测试覆盖关键路径。
  - [ ] 对缓存与幂等逻辑补充测试用例。

---

## P2（增强与长期优化）

- [ ] 搜索能力：视业务量级，考虑 FULLTEXT 或专用搜索（Meilisearch/Elastic）。
- [ ] 任务与队列：将长耗时任务入队（如生成/导入）；引入去重键与状态机。
- [ ] 成本优化：审计冷数据归档策略、缓存命中率调优、实例规格优化。
- [ ] 安全：字段级加密、密钥轮换、依赖与数据库小版本定期升级。

---

## 任务模板（复制粘贴使用）

- 标题：
- 背景：
- 目标/验收标准：
  - [ ] 
  - [ ] 
- 影响面：数据库/应用/前端/CI/运维
- 风险与回滚：
- 实施步骤：
- 预估工时/Owner/截止：
- 关联任务/PR/文档：

---

## 附录：检查清单汇总

- Schema
  - [ ] 外键、唯一、索引显式声明；唯一索引列长度 ≤ 191（utf8mb4）。
  - [ ] 关键查询 `EXPLAIN` 无全表扫描（或有合理说明）。
- 迁移
  - [ ] `migrate diff` 生成 SQL 已审阅；预生产执行通过。
  - [ ] 备份与回滚脚本准备完毕。
- 应用
  - [ ] Prisma 单例；连接池与限流设置；错误与超时策略。
- 观测
  - [ ] MySQL 慢查开启与采集；APM/Sentry 接入；阈值告警。
- 安全
  - [ ] TLS/内网/最小权限；Secret 管理；依赖与小版本升级计划。
- 灰度
  - [ ] 小流量起步、SLO 达标再放量；记录基线指标。 
