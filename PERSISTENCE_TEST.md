# ğŸ§ª å¯¹è¯æŒä¹…åŒ–åŠŸèƒ½ - æµ‹è¯•æŒ‡å—

## âœ… å·²å®ç°åŠŸèƒ½

å¯¹è¯æŒä¹…åŒ–åŠŸèƒ½ç°å·²å®Œå…¨é›†æˆï¼ä»¥ä¸‹æ˜¯æµ‹è¯•æ­¥éª¤ã€‚

### ğŸ”§ æ ¸å¿ƒæŠ€æœ¯

**Blob URL æŒä¹…åŒ–è§£å†³æ–¹æ¡ˆï¼š**
- ç”Ÿæˆå›¾ç‰‡æ—¶ï¼š`blob:http://...` â†’ ä¿å­˜ä¸º Blob å¯¹è±¡åˆ° IndexedDB
- åˆ·æ–°é¡µé¢æ—¶ï¼šBlob å¯¹è±¡ â†’ é‡æ–°ç”Ÿæˆæ–°çš„ `blob:http://...`
- åˆ©ç”¨ 3 ä¸ª IndexedDB æ•°æ®åº“ï¼š
  - `aigc-studio-conversations` - å¯¹è¯å…ƒæ•°æ®
  - `aigc-studio-image-blobs` - **å›¾ç‰‡ Blob å­˜å‚¨ï¼ˆæ–°å¢ï¼‰**
  - `aigc-studio-local` - å†å²è®°å½•ï¼ˆå·²æœ‰ï¼‰

---

## ğŸ¯ æµ‹è¯•åœºæ™¯

### åœºæ™¯ 1: åŸºç¡€æŒä¹…åŒ–æµ‹è¯•

**æ­¥éª¤ï¼š**
1. è®¿é—® `http://localhost:3000/studio-v2`
2. é€‰æ‹©ä¸€ä¸ªæ¨¡å‹
3. è¾“å…¥æç¤ºè¯ï¼š"ä¸€åªçŒ«"
4. ç‚¹å‡»å‘é€ï¼Œç­‰å¾…ç”Ÿæˆå®Œæˆ
5. **åˆ·æ–°é¡µé¢ (F5)**

**é¢„æœŸç»“æœï¼š**
- âœ… åˆ·æ–°åè‡ªåŠ¨æ˜¾ç¤º"æ­£åœ¨æ¢å¤å¯¹è¯..."åŠ è½½çŠ¶æ€
- âœ… å¯¹è¯å†…å®¹å®Œæ•´æ¢å¤ï¼ˆç”¨æˆ·æ¶ˆæ¯+åŠ©æ‰‹æ¶ˆæ¯+å›¾ç‰‡ï¼‰
- âœ… æ¨¡å‹é€‰æ‹©è‡ªåŠ¨æ¢å¤åˆ°ä¹‹å‰çš„æ¨¡å‹
- âœ… æ»šåŠ¨ä½ç½®è‡ªåŠ¨åˆ°åº•éƒ¨

**éªŒè¯æ–¹å¼ï¼š**
```javascript
// æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°ï¼ŒæŸ¥çœ‹æ—¥å¿—
// åº”è¯¥çœ‹åˆ°:
// [ConversationDB] æ•°æ®åº“åˆå§‹åŒ–æˆåŠŸ
// [ImageBlobStore] æ•°æ®åº“åˆå§‹åŒ–æˆåŠŸ  â­ æ–°å¢
// [ConversationDB] åŠ è½½ N ä¸ªå¯¹è¯
// [ConversationView] æ¢å¤å¯¹è¯: conv-xxx
// [ConversationDB] åŠ è½½ N æ¡æ¶ˆæ¯
// [ImageBlobStore] ç”Ÿæˆæ–°çš„ blob URL: msg-asst-xxx  â­ æ–°å¢
// [ConversationView] æ¢å¤å›¾ç‰‡ Blob: msg-asst-xxx  â­ æ–°å¢
// [ConversationView] å·²æ¢å¤ N æ¡æ¶ˆæ¯
```

---

### åœºæ™¯ 2: å¤šæ¬¡ç¼–è¾‘æŒä¹…åŒ–æµ‹è¯•

**æ­¥éª¤ï¼š**
1. ç”Ÿæˆä¸€å¼ å›¾ç‰‡ï¼š"ä¸€åªçŒ«"
2. ç‚¹å‡»"ä½œä¸ºè¾“å…¥"
3. è¾“å…¥ï¼š"èµ›åšæœ‹å…‹é£æ ¼"
4. ç”Ÿæˆå®Œæˆåï¼Œ**åˆ·æ–°é¡µé¢**
5. å†æ¬¡ç‚¹å‡»"ä½œä¸ºè¾“å…¥"
6. è¾“å…¥ï¼š"èƒŒæ™¯æ”¹ä¸ºä¸œäº¬"
7. ç”Ÿæˆå®Œæˆåï¼Œ**å†æ¬¡åˆ·æ–°**

**é¢„æœŸç»“æœï¼š**
- âœ… æ¯æ¬¡åˆ·æ–°éƒ½èƒ½æ¢å¤å®Œæ•´çš„ç¼–è¾‘é“¾
- âœ… ç¼–è¾‘é“¾æ—¶é—´è½´æ­£ç¡®æ˜¾ç¤ºæ‰€æœ‰èŠ‚ç‚¹
- âœ… å®Œæ•´æç¤ºè¯ç´¯ç§¯æ­£ç¡®ï¼š"ä¸€åªçŒ«, èµ›åšæœ‹å…‹é£æ ¼, èƒŒæ™¯æ”¹ä¸ºä¸œäº¬"

---

### åœºæ™¯ 3: å¯¹è¯æ ‡é¢˜è‡ªåŠ¨ç”Ÿæˆæµ‹è¯•

**æ­¥éª¤ï¼š**
1. æ¸…ç©ºæµè§ˆå™¨æ•°æ®ï¼ˆæˆ–æ‰“å¼€éšèº«çª—å£ï¼‰
2. è®¿é—®å·¥ä½œå°
3. ç¬¬ä¸€æ¬¡å‘é€æ¶ˆæ¯ï¼š"ä¸€åªèµ›åšæœ‹å…‹é£æ ¼çš„çŒ«ååœ¨ä¸œäº¬è¡—å¤´çš„éœ“è™¹ç¯ä¸‹"
4. æ‰“å¼€æµè§ˆå™¨ IndexedDB æŸ¥çœ‹å™¨

**é¢„æœŸç»“æœï¼š**
- âœ… å¯¹è¯æ ‡é¢˜è‡ªåŠ¨è®¾ç½®ä¸ºå‰30ä¸ªå­—ç¬¦
- âœ… åœ¨ IndexedDB ä¸­å¯ä»¥çœ‹åˆ°å¯¹è¯è®°å½•

**æŸ¥çœ‹ IndexedDBï¼š**
```
Chrome: F12 â†’ Application â†’ IndexedDB
  â”œâ”€ aigc-studio-conversations  (å¯¹è¯å…ƒæ•°æ®)
  â”œâ”€ aigc-studio-image-blobs    (å›¾ç‰‡ Blob å­˜å‚¨)  â­ æ–°å¢
  â””â”€ aigc-studio-local          (å†å²è®°å½•)

Firefox: F12 â†’ Storage â†’ Indexed DB
Safari: Develop â†’ Web Inspector â†’ Storage â†’ Indexed DB
```

---

### åœºæ™¯ 4: é•¿æ—¶é—´ä½¿ç”¨æµ‹è¯•

**æ­¥éª¤ï¼š**
1. åœ¨åŒä¸€ä¸ªå¯¹è¯ä¸­ç”Ÿæˆ 5 å¼ å›¾ç‰‡
2. ä¸­é€”åˆ·æ–°é¡µé¢ 2-3 æ¬¡
3. ç»§ç»­ç”Ÿæˆï¼Œå†åˆ·æ–°

**é¢„æœŸç»“æœï¼š**
- âœ… æ‰€æœ‰æ¶ˆæ¯å®Œæ•´ä¿ç•™
- âœ… å›¾ç‰‡é“¾æ¥æ­£å¸¸ï¼ˆblob URL æ­£å¸¸å·¥ä½œï¼‰
- âœ… å¯¹è¯æ ‡é¢˜ä¿æŒä¸å˜
- âœ… æ¶ˆæ¯é¡ºåºæ­£ç¡®

---

## ğŸ” è°ƒè¯•æŠ€å·§

### æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—

```javascript
// è¿‡æ»¤å¯¹è¯ç›¸å…³æ—¥å¿—
// åœ¨æ§åˆ¶å°è¾“å…¥:
localStorage.setItem('debug', 'ConversationDB,ConversationView')
```

### æ‰‹åŠ¨æŸ¥è¯¢ IndexedDB

```javascript
// åœ¨æ§åˆ¶å°æ‰§è¡Œ
(async () => {
  const db = await indexedDB.databases();
  console.log('æ•°æ®åº“åˆ—è¡¨:', db);
  
  // æŸ¥çœ‹å¯¹è¯æ•°
  const request = indexedDB.open('aigc-studio-conversations', 1);
  request.onsuccess = (e) => {
    const db = e.target.result;
    const tx = db.transaction(['conversations'], 'readonly');
    const store = tx.objectStore('conversations');
    const countReq = store.count();
    countReq.onsuccess = () => {
      console.log('å¯¹è¯æ•°é‡:', countReq.result);
    };
  };
})();
```

### æ¸…ç©ºå¯¹è¯æ•°æ®

```javascript
// åœ¨æ§åˆ¶å°æ‰§è¡Œ
indexedDB.deleteDatabase('aigc-studio-conversations');
indexedDB.deleteDatabase('aigc-studio-image-blobs'); // â­ ä¹Ÿéœ€è¦æ¸…ç©º
location.reload();
```

---

## ğŸ› å·²çŸ¥é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### é—®é¢˜ 1: åˆ·æ–°åå›¾ç‰‡ä¸æ˜¾ç¤º

**åŸå› ï¼š** blob URL å·²é‡Šæ”¾

**è§£å†³æ–¹æ¡ˆï¼š** âœ… **å·²ä¿®å¤ï¼**
- ä½¿ç”¨ `aigc-studio-image-blobs` æ•°æ®åº“å­˜å‚¨ Blob å¯¹è±¡
- åˆ·æ–°æ—¶ä» Blob é‡æ–°ç”Ÿæˆ blob URL
- ä¸å†ä¾èµ–çŸ­å‘½çš„ blob URL

### é—®é¢˜ 2: å¯¹è¯æœªè‡ªåŠ¨æ¢å¤

**åŸå› :** IndexedDB åˆå§‹åŒ–å¤±è´¥

**æ£€æŸ¥æ­¥éª¤:**
1. ç¡®è®¤æµè§ˆå™¨æ”¯æŒ IndexedDB
2. æ£€æŸ¥æ˜¯å¦åœ¨éšç§/æ— ç—•æ¨¡å¼ï¼ˆéƒ¨åˆ†æµè§ˆå™¨é™åˆ¶ IndexedDBï¼‰
3. æŸ¥çœ‹æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯æ—¥å¿—

**è§£å†³æ–¹æ¡ˆ:**
```javascript
// æ£€æŸ¥ IndexedDB æ”¯æŒ
console.log('IndexedDB æ”¯æŒ:', 'indexedDB' in window);

// æ£€æŸ¥å­˜å‚¨é…é¢
navigator.storage.estimate().then(estimate => {
  console.log('å­˜å‚¨ä½¿ç”¨:', estimate.usage, '/', estimate.quota);
});
```

### é—®é¢˜ 3: å¯¹è¯æ ‡é¢˜æ˜¾ç¤ºä¸º"æ–°å¯¹è¯"

**åŸå› :** å¯¹è¯åˆ›å»ºåç”¨æˆ·æœªå‘é€æ¶ˆæ¯

**è§£å†³æ–¹æ¡ˆ:**
- å‘é€ç¬¬ä¸€æ¡æ¶ˆæ¯åæ ‡é¢˜ä¼šè‡ªåŠ¨æ›´æ–°
- è¿™æ˜¯æ­£å¸¸è¡Œä¸ºï¼Œä¸å½±å“åŠŸèƒ½

---

## ğŸ“Š æ€§èƒ½æµ‹è¯•

### å­˜å‚¨å®¹é‡æµ‹è¯•

```javascript
// æµ‹è¯•å­˜å‚¨å®¹é‡
(async () => {
  const db = await indexedDB.open('aigc-studio-conversations', 1);
  
  // åˆ›å»º 100 æ¡æµ‹è¯•æ¶ˆæ¯
  for (let i = 0; i < 100; i++) {
    const msg = {
      id: `test-${i}`,
      conversationId: 'test-conv',
      role: 'user',
      content: `æµ‹è¯•æ¶ˆæ¯ ${i}`,
      timestamp: Date.now() + i
    };
    // ä¿å­˜é€»è¾‘...
  }
  
  console.log('100 æ¡æ¶ˆæ¯å·²åˆ›å»º');
})();
```

### æ¢å¤é€Ÿåº¦æµ‹è¯•

```javascript
// æµ‹è¯•æ¢å¤æ—¶é—´
console.time('å¯¹è¯æ¢å¤');
// åˆ·æ–°é¡µé¢
// çœ‹åˆ°"å·²æ¢å¤ N æ¡æ¶ˆæ¯"æ—¥å¿—å
console.timeEnd('å¯¹è¯æ¢å¤');

// é¢„æœŸ: < 500ms (å¯¹äºæ™®é€šå¯¹è¯)
```

---

## âœ… åŠŸèƒ½éªŒè¯æ¸…å•

åœ¨æäº¤ PR æˆ–éƒ¨ç½²å‰ï¼Œç¡®ä¿ä»¥ä¸‹æµ‹è¯•é€šè¿‡ï¼š

- [ ] åˆæ¬¡è®¿é—®è‡ªåŠ¨åˆ›å»ºæ–°å¯¹è¯
- [ ] å‘é€æ¶ˆæ¯ååˆ·æ–°èƒ½æ¢å¤
- [ ] ç¼–è¾‘é“¾åˆ·æ–°åå®Œæ•´æ¢å¤
- [ ] å¯¹è¯æ ‡é¢˜è‡ªåŠ¨ç”Ÿæˆ
- [ ] æ¨¡å‹é€‰æ‹©è‡ªåŠ¨æ¢å¤
- [ ] å›¾ç‰‡æ­£å¸¸æ˜¾ç¤ºï¼ˆblob URL æœ‰æ•ˆï¼‰
- [ ] æ§åˆ¶å°æ— æŠ¥é”™
- [ ] IndexedDB æ•°æ®ç»“æ„æ­£ç¡®
- [ ] å¤šæ¬¡åˆ·æ–°åæ•°æ®ä¸ä¸¢å¤±
- [ ] é•¿å¯¹è¯ï¼ˆ10+æ¶ˆæ¯ï¼‰æ¢å¤æ­£å¸¸

---

## ğŸš€ ä¸‹ä¸€æ­¥æµ‹è¯•

### å¾…å®ç°åŠŸèƒ½æµ‹è¯•

1. **ä¼šè¯åˆ—è¡¨** (UIä¼˜åŒ–2)
   - åˆ›å»ºå¤šä¸ªå¯¹è¯
   - åˆ‡æ¢å¯¹è¯
   - é‡å‘½åå¯¹è¯
   - åˆ é™¤å¯¹è¯

2. **æ—¶é—´è½´èŠ‚ç‚¹å›é€€**
   - ç‚¹å‡»ç¼–è¾‘é“¾èŠ‚ç‚¹
   - å›åˆ°æŒ‡å®šçŠ¶æ€
   - ä»è¯¥çŠ¶æ€ç»§ç»­ç¼–è¾‘

3. **å‘å¸ƒåŠŸèƒ½** (é˜¶æ®µ3)
   - ç‚¹å‡»å‘å¸ƒæŒ‰é’®
   - å¡«å†™å‘å¸ƒè¡¨å•
   - æäº¤åˆ°æœåŠ¡å™¨
   - æŸ¥çœ‹é¦–é¡µæ›´æ–°

---

## ğŸ“ æŠ¥å‘Šé—®é¢˜

å¦‚æœå‘ç°ä»»ä½•é—®é¢˜ï¼Œè¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š

1. **æµè§ˆå™¨å’Œç‰ˆæœ¬**
2. **æ§åˆ¶å°æ—¥å¿—æˆªå›¾**
3. **IndexedDB æ•°æ®æˆªå›¾**
4. **å¤ç°æ­¥éª¤**
5. **é¢„æœŸè¡Œä¸º vs å®é™…è¡Œä¸º**

---

**æµ‹è¯•å®Œæˆæ ‡å¿—:** æ‰€æœ‰åœºæ™¯æµ‹è¯•é€šè¿‡ + éªŒè¯æ¸…å•å…¨éƒ¨å‹¾é€‰ âœ…

**æœ€åæ›´æ–°ï¼š** 2025-01-14 23:00 UTC

---

## ğŸ”§ æŠ€æœ¯è¯¦æƒ…

### Blob å­˜å‚¨æ¶æ„

```
ç”Ÿæˆå›¾ç‰‡æµç¨‹ï¼š
1. API è¿”å› URL â†’ useLocalHistory åˆ›å»º Blob â†’ ç”Ÿæˆ blob:// URL
2. ä¿å­˜æ¶ˆæ¯æ—¶ï¼šblob:// URL â†’ fetch Blob â†’ å­˜å…¥ IndexedDB

æ¢å¤å›¾ç‰‡æµç¨‹ï¼š
1. ä»æ¶ˆæ¯è®°å½•è·å–æ¶ˆæ¯ ID
2. ä½¿ç”¨æ¶ˆæ¯ ID æŸ¥è¯¢ image-blobs æ•°æ®åº“
3. Blob â†’ URL.createObjectURL() â†’ æ–°çš„ blob:// URL
4. æ›¿æ¢æ¶ˆæ¯ä¸­çš„ imageUrl
```

### æ•°æ®åº“ç»“æ„

**aigc-studio-image-blobs:**
```typescript
interface ImageBlobRecord {
  id: string;        // æ¶ˆæ¯ ID (ä¸»é”®)
  blob: Blob;        // å›¾ç‰‡ Blob å¯¹è±¡
  timestamp: number; // ä¿å­˜æ—¶é—´æˆ³
}
```

**å…³é”® APIï¼š**
- `imageBlobStore.saveBlobFromURL(id, blobURL)` - ä¿å­˜
- `imageBlobStore.getBlobURL(id)` - æ¢å¤
- `imageBlobStore.deleteBlob(id)` - åˆ é™¤
- `imageBlobStore.clearAll()` - æ¸…ç©º
