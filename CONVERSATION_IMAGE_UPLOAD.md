# 对话模式图片上传功能

## 功能说明

在对话界面（Conversation View）的输入框中新增了多图片上传功能，允许用户上传图片并配合文本提示词进行 AI 二次编辑（图生图）。

## 使用方法

### 1. 上传图片

在对话输入框底部工具栏，点击**"图片"**按钮即可上传图片。

**支持的操作：**
- **单次多选**：点击上传按钮后，可按住 `Cmd/Ctrl` 选择多张图片
- **多次添加**：可以多次点击上传按钮，追加更多图片
- **拖拽上传**：（未来可扩展）

### 2. 管理已上传图片

上传后的图片会在输入框上方显示缩略图预览：

- **图片序号**：每张图片左下角显示序号（1、2、3...）
- **单个删除**：鼠标悬停到图片上，点击右上角的 ❌ 按钮删除该图片
- **批量清空**：当上传多张图片时，会显示"清空"按钮，可一键删除所有图片
- **数量显示**：上传按钮会显示当前已上传的图片数量，如 `图片 (3)`

### 3. 发送消息

输入提示词后点击"发送"按钮或按 `Cmd/Ctrl + Enter` 快捷键：

- **文生图模式**：如果没有上传图片，将执行普通的文生图
- **图生图模式**：如果上传了图片，将使用第一张图片作为基础图进行二次编辑

**注意事项：**
- 当前版本使用第一张图片进行编辑，后续图片暂不处理
- 发送消息后，已上传的图片会自动清空
- 系统会显示提示信息，告知使用了哪张图片

## 工作流程

### 场景 1：全新图生图
1. 点击"图片"按钮上传一张或多张图片
2. 输入修改指令，如："把背景改成星空"
3. 点击发送，AI 将基于第一张图片进行编辑

### 场景 2：持续编辑
1. 生成图片 A
2. 不上传新图片，直接输入："增加更多细节"
3. 系统自动使用上一次生成的图片 A 作为基础
4. 生成图片 B

### 场景 3：切换基础图
1. 生成图片 A
2. 上传新图片 X
3. 输入："使用这个风格重新生成"
4. 系统使用上传的图片 X 进行编辑

## 技术细节

### 前端实现
- **组件**：`components/ai/conversation/input-area.tsx`
- **状态管理**：
  - `uploadedImages: File[]` - 已上传的图片文件数组
  - `imagePreviewUrls: string[]` - 图片预览 URL 数组
- **多选支持**：`<input type="file" multiple accept="image/*" />`

### 后端处理
- **API 端点**：`/api/ai/images/edits`
- **图片处理**：使用 `FormData` 传输图片文件
- **提示词合并**：支持原始 Prompt 和新 Prompt 的智能合并

### 数据流
```
用户上传图片 → File[] 存储在状态
     ↓
用户输入提示词
     ↓
点击发送 → handleSend(prompt, uploadedImages)
     ↓
FormData.append('image', uploadedImages[0])
     ↓
POST /api/ai/images/edits
     ↓
AI 生成结果 → 显示在消息列表
```

## 未来扩展

### 可能的功能增强
1. **多图融合**：支持将多张图片融合成一张
2. **批量处理**：一次生成多个变体
3. **拖拽排序**：调整图片优先级
4. **图片裁剪**：上传前可进行简单编辑
5. **粘贴上传**：支持从剪贴板粘贴图片

### 性能优化
- 图片压缩：自动压缩大图以减少上传时间
- 预览优化：使用 thumbnail 减少内存占用
- 懒加载：大量图片时分页显示

## 相关文件

- `components/ai/conversation/input-area.tsx` - 输入框组件（图片上传 UI）
- `components/ai/conversation/conversation-view.tsx` - 对话视图（处理图片编辑逻辑）
- `app/api/ai/images/edits/route.ts` - 图片编辑 API 端点
- `lib/ai/images.ts` - 图片处理核心逻辑

## 问题排查

### 图片上传后不显示
- 检查文件类型是否为 `image/*`
- 查看浏览器控制台是否有错误
- 确认 FileReader 是否成功读取

### 发送后没有调用图生图 API
- 检查 `uploadedImages` 数组是否为空
- 确认 `hasUploadedImages` 判断逻辑
- 查看网络请求是否发送到 `/api/ai/images/edits`

### 多图片只使用了第一张
- 这是当前设计的预期行为
- 如需支持多图处理，需要扩展后端 API 和前端逻辑

## 更新日志

### v1.0.0 (2025-10-20)
- ✅ 支持多图片上传
- ✅ 图片预览和管理
- ✅ 单个删除和批量清空
- ✅ 图片序号标记
- ✅ 上传数量显示
- ✅ 自动使用第一张图片进行编辑
