# Prompt Fusion（简化复用）设计文档 v1

面向普通用户的极简复用：用户点击“复用”后仅输入一段新提示词，系统用 AI 将“示例提示词 + 用户新提示词”融合为最终提示词并直接生成；不暴露微调参数与专业控件。

## 1. 目标与范围
- 仅一个输入动作完成二次创作；无风格/镜头/尺寸等参数面板。
- 融合策略默认“稳妥改写”：尽量保留示例的构图/风格基调，覆盖主体与关键信息。
- 成本与延迟低：单次轻量模型调用（推荐 Gemini 2.5 Flash），失败时回退到规则拼接。

非目标：本阶段不做按需分类与复杂结构化提取；不做跨模型深度语法迁移，只做最小保留。

## 2. 用户流程（UX）
1) 用户点击“复用”。
2) 跳转到对话式生图，自动弹出“复用”弹窗：
   - 左：示例图（如有）+ 原提示词一小段只读摘要（可展开）。
   - 右：一个多行输入框（placeholder：描述你想改成的内容）。
   - 底部：按钮 [融合生成]，辅助链接 [直接用示例生成]。
3) 点击 [融合生成]：
   - 调用 /api/prompt/fuse 完成融合 → 关闭弹窗 → 将 finalPrompt 作为会话首条消息发送并开始生成。
4) 会话中保留来源示例ID与原提示词，便于溯源与再次复用。

## 3. 接口与数据契约
- POST /api/prompt/fuse
  - 请求：
    ```json path=null start=null
    {
      "basePrompt": "string",        // 示例提示词
      "userPrompt": "string",        // 用户新输入
      "lang": "zh|en|null"           // 可选，便于语言统一；不传则自动检测
    }
    ```
  - 响应：
    ```json path=null start=null
    {
      "finalPrompt": "string",       // 融合后的最终提示词（直接用于生成）
      "genParams": {                   // 可选，供后端生成使用（不暴露给用户）
        "aspectRatio": "string|null",
        "width": 0,
        "height": 0,
        "seed": 0,
        "negative": ["string"]
      },
      "notes": ["string"]            // 可选：融合时的保留/替换说明
    }
    ```

说明：genParams 从 basePrompt 中“尽量保留”，仅在可可靠提取时提供；否则为空，由模型默认。

## 4. 融合规则（最小集）
- 保留优先（内部自动，用户无感）：
  - 明确参数标记：负面词（negative/ng:）、种子（seed:123）、比例/尺寸（ar x:y, WxH）、LoRA/ControlNet 标签、权重括号(( ))。
  - 若能稳定提取到，则写入 genParams 并在文本中避免重复描述。
- 覆盖优先：
  - 用户新意图（主体/性别/年龄/对象/场景/风格关键词）覆盖 basePrompt 中同类信息。
- 清理与统一：
  - 语言统一（按 lang 或自动）；去重近义词；合并重复形容词；避免自相矛盾。
- 输出风格：
  - 单段、逗号分隔或模型偏好的自然短句；不过长（目标 ≤ 800 字符）。

## 5. LLM 策略（轻量）
- 模型：Gemini 2.5 Flash（或等价低成本），temperature=0，严格 JSON 输出。
- 提示词（摘要版）：
  ```text path=null start=null
  任务：融合 basePrompt 与 userPrompt，生成 finalPrompt；尽量保留可提取的参数（负面词/比例/尺寸/seed/LoRA等）到 genParams。仅输出 JSON。
  约束：
  - 若有冲突，以 userPrompt 优先；
  - 保留 basePrompt 的构图与风格基调；
  - 删除重复或矛盾词；
  - finalPrompt 不包含显式参数标记（如 ng:, seed:），这些放入 genParams。
  输出键：finalPrompt, genParams(aspectRatio|width|height|seed|negative[]), notes[]。
  ```
- 超时：≤ 1200ms；失败/超时回退到规则拼接（见 §6）。
- 截断：输入合并后截断至 1500 字符，保护延迟与成本。
- 缓存：以 hash(basePrompt+userPrompt) 缓存 24h。

## 6. 回退策略（无 LLM）
- 规则拼接：
  - 提取 basePrompt 中的参数标记 → 作为 genParams；
  - finalPrompt = 先对 basePrompt 做轻量去重清理 + 追加句“Based on user intent: {userPrompt}”或中文等价表达；
  - 去除重复与明显矛盾片段。

## 7. 性能与成本
- 单次 LLM 调用，典型 < 500 token；P95 延迟目标 ≤ 1.8s（含网络）。
- 高命中缓存的样例（热门示例）成本趋近零。

## 8. 风险与对策
- 走样：在系统提示中强调“保留构图/基调”；如走样率偏高，可在服务端追加轻度后处理（关键词重插）。
- 异常/超时：回退策略确保可用；埋点告警。
- 多语言：自动检测 + 统一输出；或始终输出与 basePrompt 相同语言。
- 违规/品牌：不生成真实 Logo/商标图案；如出现违规术语，直接原样保留为“文本描述”。

## 9. 交付计划
- P0（1-2 天）：
  - /api/prompt/fuse + LLM 调用 + 回退；
  - 复用弹窗（单输入框）与生成链路打通；
  - 基本日志与缓存。
- P1（2-3 天）：
  - 融合质量调优（去重/矛盾检测）；
  - 多语言统一与负面词/比例等稳定提取；
  - 指标面板（成功率、超时率、用户二次编辑率）。

## 10. 验收标准（DoD）
- 100 条混合样本上：
  - 生成可用率 ≥ 95%（无异常/空输出/格式错误）；
  - 走样投诉率 ≤ 10%；
  - 回退触发率 ≤ 15%，且回退结果可用率 ≥ 90%。
- P95 融合接口延迟 ≤ 1.8s；缓存命中率 ≥ 50%（热门资源期）。
